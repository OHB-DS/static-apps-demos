<html>

<head>
  <title>CoastSat transects (including NZ)</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"/>
  <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
  <script src="https://unpkg.com/leaflet.glify@3.3.0/dist/glify-browser.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js"></script>
  <script src="https://unpkg.com/leaflet-spin@1.1.0/leaflet.spin.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet-geosearch@latest/dist/bundle.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@latest/assets/css/leaflet.css">
  <script src="https://unpkg.com/leaflet-providers@1.3.0/leaflet-providers.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.4.2/chroma.min.js"
    integrity="sha512-zInFF17qBFVvvvFpIfeBzo7Tj7+rQxLeTJDmbxjBz5/zIr89YVbTNelNhdTT+/DCrxoVzBeUPVFJsczKbB7sew=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="
https://cdn.jsdelivr.net/npm/leaflet-sidebar-v2@3.2.3/js/leaflet-sidebar.min.js
"></script>
<link href="
https://cdn.jsdelivr.net/npm/leaflet-sidebar-v2@3.2.3/css/leaflet-sidebar.min.css
" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  
  <style>
      body,
      html,
      #map {
          width: 100%;
          height: 100%;
          margin: 0;
          padding: 0;
      }

      .legend {
          color: white;
          padding: 10px;
          background-color: rgba(0, 0, 0, 0.8);
          border-radius: 5px;
          max-width: 500px;
      }

      .legend i {
          width: 18px;
          height: 18px;
          float: left;
          margin-right: 8px;
          opacity: 0.7;
          clear: left;
      }

      .legend h4 {
        margin-top: 0px;
      }

      .link {
          text-decoration: underline;
          cursor: pointer;
      }

      .fa {
        line-height: inherit;
      }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="sidebar" class="leaflet-sidebar collapsed">
      <!-- Nav tabs -->
      <div class="leaflet-sidebar-tabs">
          <ul role="tablist"> <!-- top aligned tabs -->
              <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
              <li><a href="https://www.ohb-ds.de/en/digital-solutions/earth-observation"><i class="fa fa-info"></i></a></li>
          </ul>
      </div>

      <!-- Tab panes -->
      <div class="leaflet-sidebar-content">
          <div class="leaflet-sidebar-pane" id="home">
            <div id="attribution"><strong>EO4PORTS: Low Tide Line tracking</strong><br>
              <img src="./examples/E4PORTS_logo.png" alt="Feature Image" style="width: 50%; max-height: 300px; object-fit: contain;" /><br>
              EO4PORTS is a research and development project funded by ESA with the objective to leverage Earth Observation data to improve port operations in Europe.<br><br>
              This platform presents the <strong>Low-tide line tracking</strong>, one of the three EO products developed for EO4PORTS. 
              This product uses optical satellite images from Landsat and Sentinel-2 to map the position of the low tide line, which captures
              sandy features around ports and navigation channels.
          </div>
      </div>
  </div>
  <script>

    var map = L.map('map', {
      center: [53.599472, 6.877775],
      zoom: 7,
      //worldCopyJump: true
    })

    var sidebar = L.control.sidebar({
        autopan: false,       // whether to maintain the centered map point when opening the sidebar
        closeButton: true,    // whether t add a close button to the panes
        container: 'sidebar', // the DOM container or #ID of a predefined sidebar container that should be used
        position: 'right',     // left or right
    }).addTo(map)//.open("home")

    var baseMaps = {
      "OSM": L.tileLayer.provider("OpenStreetMap.Mapnik"),
      "Google Hybrid": L.tileLayer('http://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
        maxZoom: 20,
        subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
      }),
      "CartoDB Positron": L.tileLayer.provider('CartoDB.Positron'),
      // "CartoDB Dark Matter": L.tileLayer.provider("CartoDB.DarkMatter"),
      "ESRI WorldImagery": L.tileLayer.provider("Esri.WorldImagery").addTo(map),
    }

    // Create a layer control and place it in the upper-left corner
    const layerControl = L.control.layers(
      baseMaps, // Base layers
      {}, // Overlays (empty for now)
      { position: 'topleft' } // Set position to the top-left
    ).addTo(map);

    var cmap = chroma.scale('RdYlBu').domain([-3, 3])
    const prefix = "2024_Wadden_Sea"
    const suffix = "lowtideline_v5"

    map.spin(true);

    ///////////////////////////////////////////////////////////////////////////
    // LOW TIDE LINES
    ///////////////////////////////////////////////////////////////////////////
    const fp = "./data/Wadden_Sea/3_geojson";
    const fn = "Wadden_Sea_lowtideline_2024_v5.geojson";
    const full_path_geojson = `${fp}/${fn}`;
    console.log(full_path_geojson);
    $.getJSON(full_path_geojson, function (geojson) {
      console.log(geojson)
      for (var f of geojson.features) {
        for (var c of f.geometry.coordinates) {
          if (c[0] < 0) c[0] += 360
        }
      }
      // Add the GeoJSON to the map with black styling
      contourLayer = L.geoJSON(geojson, {
          style: function () {
              return {                             
                color: "black",  // Set line color to black
                weight: 1.5        // Set line width (reduce it)
            };
          },
          onEachFeature: function (feature, layer) {

                        // Extract attributes for the popup
                        const properties = feature.properties || {};
                        const attributes = Object.entries(properties)
                            .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                            .join("<br>");
                        // Extract the image URL (assumed to be in an "image_url" property)
                        const imageUrl = `./data/Wadden_Sea/2_tides/${properties.tile}_tide_timeseries_v5.jpg`;
                        // Create popup content
                        let popupContent = `<div>${attributes}</div>`;
                        // if (imageUrl) {
                        //     popupContent += `<div style="margin-top: 10px;">
                        //         <img src="${imageUrl}" alt="Feature Image" style="width: 100%; max-height: 700px; object-fit: contain;" />
                        //     </div>`;
                        // }

                        // Bind the popup to the layer
                        layer.bindPopup(popupContent, {
                            maxWidth: 500, // Set maximum width
                            minWidth: 300  // Set minimum width
                        });

                        // Highlight the line on mouseover
                        layer.on('mouseover', function () {
                            layer.setStyle({
                                color: "red",   // Highlight color
                                weight: 3       // Highlight width
                            });
                        });

                        // Reset the line style on mouseout
                        layer.on('mouseout', function () {
                            layer.setStyle({
                                color: "black", // Default color
                                weight: 1       // Default width
                            });
                        });

                        // Open popup on click
                        layer.on('click', function () {
                            layer.openPopup();
                        });
                    }
          });
          contourLayer.addTo(map);
          // Add the GeoJSON layer to the map and layer control
          layerControl.addOverlay(contourLayer, "Low Tide contours");
    });

    ///////////////////////////////////////////////////////////////////////////
    // GRID CELLS
    ///////////////////////////////////////////////////////////////////////////
    const full_path_tiles = "./ROIs/Wadden_Sea_grid_sel.geojson";
    $.getJSON(full_path_tiles, function (geojson) {
      console.log(geojson)
      for (var f of geojson.features) {
        for (var c of f.geometry.coordinates) {
          if (c[0] < 0) c[0] += 360
        }
      }
      // Add the GeoJSON to the map with black styling
      gridLayer = L.geoJSON(geojson, {
          style: function () {
              return {                             
                color: "black",  // Set line color to black
                weight: 1,     // Set line width
            };
          },
          onEachFeature: function (feature, layer) {
                        const selectedAttributes = ["grid_id"];
                        // Extract attributes for the popup
                        const properties = feature.properties || {};
                        const attributes = Object.entries(properties)
                            .filter(([key]) => selectedAttributes.includes(key))
                            .map(([key, value]) => `<strong>${key}:</strong> ${value}`)
                            .join("<br>");

                        // Extract the image URL
                        const imageUrl = `./data/Wadden_Sea/1_images/simple/${prefix}_${properties.grid_id}_${suffix}.jpg`;

                        // Create popup content
                        let popupContent = `<div>${attributes}</div>`;
                        if (imageUrl) {
                            popupContent += `<div style="margin-top: 10px;">
                                <img src="${imageUrl}" alt="Feature Image" style="width: 100%; max-height: 800px; object-fit: contain;" />
                            </div>`;
                        }

                        // Bind the popup to the layer
                        layer.bindPopup(popupContent, {
                            maxWidth: 700, // Set maximum width
                            minWidth: 400  // Set minimum width
                        });

                        // Highlight the line on mouseover
                        layer.on('mouseover', function () {
                            layer.setStyle({
                                color: "red",   // Highlight color
                                weight: 3       // Highlight width
                            });
                        });

                        // Reset the line style on mouseout
                        layer.on('mouseout', function () {
                            layer.setStyle({
                                color: "black", // Default color
                                weight: 1       // Default width
                            });
                        });

                        // Open popup on click
                        layer.on('click', function () {
                            layer.openPopup();
                        });
                    }
          });
          gridLayer.addTo(map);
          layerControl.addOverlay(gridLayer, "Processing tiles (NDWI)");
    });

    var geoSearch = new GeoSearch.GeoSearchControl({
      provider: new GeoSearch.OpenStreetMapProvider(),
      style: 'button',
      autoComplete: true,
      autoCompleteDelay: 250,
      autoClose: true,
      position: "topleft"
    }).addTo(map);

    map.spin(false);

    // var legend = L.control({ position: 'bottomright' });
    // legend.onAdd = function (map) {
    //   var div = L.DomUtil.create('div', 'info legend');
    //   div.innerHTML += "<h4>Trend (m / year)</h4>"
    //   for (var i = -3; i <= 3; i++) {
    //     var prefix = ""
    //     if (i == -3) {
    //       prefix = "≤ "
    //     } else if (i == 3) {
    //       prefix = "≥ "
    //     }
    //     div.innerHTML += `<i style="background:${cmap(i).css()}"></i>${prefix + i}<br>`
    //   }
    //   div.innerHTML += `<i style="background:black"></i>Uncertain<br>`
    //   return div;
    // };
    // legend.addTo(map);

  </script>
</body>

</html>